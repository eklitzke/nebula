PROJECT(nebula)
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)

# CXXFLAGS used by compiler.
SET(CMAKE_CXX_FLAGS "-Wall -Wextra -Werror -std=c++11 -I/usr/include/SDL -D_GNU_SOURCE=1 -D_REENTRANT")
SET(CMAKE_CXX_FLAGS_RELEASE "-O3")
SET(CMAKE_CXX_FLAGS_DEBUG "-ggdb -DDEBUG -DDISASSEMBLER")

# LDFLAGS used when linking nebula.
SET(NEBULA_LDFLAGS -L/usr/lib -lSDL -lpthread)

# List of all the files of the project.
SET(NEBULA_SRCS
    src/graphics/bgwtile.cc
    src/graphics/gpu.cc
    src/graphics/sprites.cc
    src/graphics/timer.cc
    src/keyboard/keyboard.cc
    src/logging.cc
    src/main.cc
    src/memory/mbcs/mbc.cc
    src/memory/mbcs/mbc1.cc
    src/memory/mbcs/romonly.cc
    src/memory/mmu.cc
    src/z80/interrupts.cc
    src/z80/z80.cc
    src/z80/z80cbopcodes.cc
    src/z80/z80disassembler.cc
    src/z80/z80opcodes.cc
)

# These files are generated by custom command just after it.
SET(NEBULA_DEFINITIONS
    ${CMAKE_CURRENT_BINARY_DIR}/src/z80/disass.def
    ${CMAKE_CURRENT_BINARY_DIR}/src/z80/cbopcodes.def
    ${CMAKE_CURRENT_BINARY_DIR}/src/z80/opcodes.def
)

ADD_CUSTOM_COMMAND(
    OUTPUT ${NEBULA_DEFINITIONS}
    COMMAND ${CMAKE_CURRENT_BINARY_DIR}/src/z80/gen_opcodes.py
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/src/z80/gen_opcodes.py
)

# distclean target
IF(UNIX)
    ADD_CUSTOM_TARGET(distclean @echo cleaning for source distribution)

    ADD_CUSTOM_COMMAND(
        COMMENT "distribution clean"
        COMMAND make -C ${CMAKE_CURRENT_BINARY_DIR} clean
        COMMAND rm "${CMAKE_CURRENT_BINARY_DIR}/CMakeCache.txt"
        COMMAND rm "${CMAKE_CURRENT_BINARY_DIR}/Makefile"
        COMMAND rm -rf "${CMAKE_CURRENT_BINARY_DIR}/CMakeFiles"
        COMMAND rm -f "${CMAKE_CURRENT_BINARY_DIR}/cmake_install.cmake"
        TARGET  distclean
    )
ENDIF(UNIX)

# Builds and links executable.
ADD_EXECUTABLE(nebula ${NEBULA_SRCS} ${NEBULA_DEFINITIONS})
TARGET_LINK_LIBRARIES(nebula ${NEBULA_LDFLAGS})
